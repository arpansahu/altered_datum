{"ast":null,"code":"import axios from 'axios';\nconst base_url = process.env.REACT_APP_API_BASE_URL;\nconst baseURL = `${base_url}/api/`;\nconst accessToken = localStorage.getItem('access_token');\nconst refreshToken = localStorage.getItem('refresh_token');\nconst axiosInstance = axios.create({\n  baseURL: baseURL,\n  timeout: 5000,\n  headers: {\n    Authorization: accessToken ? `Bearer ${accessToken}` : null,\n    'Content-Type': 'application/json',\n    Accept: 'application/json'\n  }\n});\naxiosInstance.interceptors.response.use(response => {\n  return response;\n}, async error => {\n  const originalRequest = error.config;\n\n  if (!error.response) {\n    alert('A server/network error occurred. ' + 'Looks like CORS might be the problem. ' + 'Sorry about this - we will get it fixed shortly.');\n    return Promise.reject(error);\n  }\n\n  if (error.response.status === 401 && originalRequest.url === `${baseURL}token/refresh/`) {\n    window.location.href = '/login/';\n    return Promise.reject(error);\n  }\n\n  if (error.response.data.code === 'token_not_valid' && error.response.status === 401 && error.response.statusText === 'Unauthorized') {\n    if (refreshToken) {\n      const tokenParts = JSON.parse(atob(refreshToken.split('.')[1])); // exp date in token is expressed in seconds, while now() returns milliseconds:\n\n      const now = Math.ceil(Date.now() / 1000);\n\n      if (tokenParts.exp > now) {\n        try {\n          const response = await axiosInstance.post('/token/refresh/', {\n            refresh: refreshToken\n          });\n          localStorage.setItem('access_token', response.data.access);\n          localStorage.setItem('refresh_token', response.data.refresh);\n          axiosInstance.defaults.headers['Authorization'] = `Bearer ${response.data.access}`;\n          originalRequest.headers['Authorization'] = `Bearer ${response.data.access}`;\n          return axiosInstance(originalRequest);\n        } catch (err) {\n          console.error(err);\n        }\n      } else {\n        console.log('Refresh token is expired', tokenParts.exp, now);\n        window.location.href = '/login/';\n      }\n    } else {\n      console.log('Refresh token not available.');\n      window.location.href = '/login/';\n    }\n  } // specific error handling done elsewhere\n\n\n  return Promise.reject(error);\n});\nexport default axiosInstance;","map":{"version":3,"sources":["/Users/arpansahu/projects/profile/altered_datum/src/axios.js"],"names":["axios","base_url","process","env","REACT_APP_API_BASE_URL","baseURL","accessToken","localStorage","getItem","refreshToken","axiosInstance","create","timeout","headers","Authorization","Accept","interceptors","response","use","error","originalRequest","config","alert","Promise","reject","status","url","window","location","href","data","code","statusText","tokenParts","JSON","parse","atob","split","now","Math","ceil","Date","exp","post","refresh","setItem","access","defaults","err","console","log"],"mappings":"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","sourcesContent":["import axios from 'axios';\n\nconst base_url = process.env.REACT_APP_API_BASE_URL;\nconst baseURL = `${base_url}/api/`;\n\nconst accessToken = localStorage.getItem('access_token');\nconst refreshToken = localStorage.getItem('refresh_token');\n\nconst axiosInstance = axios.create({\n\tbaseURL: baseURL,\n\ttimeout: 5000,\n\theaders: {\n\t\tAuthorization: accessToken ? `Bearer ${accessToken}` : null,\n\t\t'Content-Type': 'application/json',\n\t\tAccept: 'application/json',\n\t},\n});\n\naxiosInstance.interceptors.response.use(\n\t(response) => {\n\t\treturn response;\n\t},\n\tasync (error) => {\n\t\tconst originalRequest = error.config;\n\n\t\tif (!error.response) {\n\t\t\talert(\n\t\t\t\t'A server/network error occurred. ' +\n\t\t\t\t\t'Looks like CORS might be the problem. ' +\n\t\t\t\t\t'Sorry about this - we will get it fixed shortly.'\n\t\t\t);\n\t\t\treturn Promise.reject(error);\n\t\t}\n\n\t\tif (\n\t\t\terror.response.status === 401 &&\n\t\t\toriginalRequest.url === `${baseURL}token/refresh/`\n\t\t) {\n\t\t\twindow.location.href = '/login/';\n\t\t\treturn Promise.reject(error);\n\t\t}\n\n\t\tif (\n\t\t\terror.response.data.code === 'token_not_valid' &&\n\t\t\terror.response.status === 401 &&\n\t\t\terror.response.statusText === 'Unauthorized'\n\t\t) {\n\t\t\tif (refreshToken) {\n\t\t\t\tconst tokenParts = JSON.parse(atob(refreshToken.split('.')[1]));\n\n\t\t\t\t// exp date in token is expressed in seconds, while now() returns milliseconds:\n\t\t\t\tconst now = Math.ceil(Date.now() / 1000);\n\n\t\t\t\tif (tokenParts.exp > now) {\n\t\t\t\t\ttry {\n\t\t\t\t\t\tconst response = await axiosInstance.post('/token/refresh/', { refresh: refreshToken });\n\t\t\t\t\t\tlocalStorage.setItem('access_token', response.data.access);\n\t\t\t\t\t\tlocalStorage.setItem('refresh_token', response.data.refresh);\n\n\t\t\t\t\t\taxiosInstance.defaults.headers['Authorization'] = `Bearer ${response.data.access}`;\n\t\t\t\t\t\toriginalRequest.headers['Authorization'] = `Bearer ${response.data.access}`;\n\n\t\t\t\t\t\treturn axiosInstance(originalRequest);\n\t\t\t\t\t} catch (err) {\n\t\t\t\t\t\tconsole.error(err);\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\tconsole.log('Refresh token is expired', tokenParts.exp, now);\n\t\t\t\t\twindow.location.href = '/login/';\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tconsole.log('Refresh token not available.');\n\t\t\t\twindow.location.href = '/login/';\n\t\t\t}\n\t\t}\n\n\t\t// specific error handling done elsewhere\n\t\treturn Promise.reject(error);\n\t}\n);\n\nexport default axiosInstance;"]},"metadata":{},"sourceType":"module"}