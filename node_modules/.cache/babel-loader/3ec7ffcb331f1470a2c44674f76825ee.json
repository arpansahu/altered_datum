{"ast":null,"code":"import axios from'axios';const base_url=process.env.REACT_APP_API_BASE_URL;const baseURL=`${base_url}/api/`;const axiosInstance=axios.create({baseURL:baseURL,timeout:5000,headers:{Authorization:localStorage.getItem('access_token')?`Bearer ${localStorage.getItem('access_token')}`:null,'Content-Type':'application/json',accept:'application/json'}});axiosInstance.interceptors.response.use(response=>{return response;},async error=>{const originalRequest=error.config;if(!error.response){alert('A server/network error occurred. '+'Looks like CORS might be the problem. '+'Sorry about this - we will get it fixed shortly.');return Promise.reject(error);}if(error.response.status===401&&originalRequest.url===`${baseURL}token/refresh/`){window.location.href='/login/';return Promise.reject(error);}if(error.response.data.code==='token_not_valid'&&error.response.status===401&&error.response.statusText==='Unauthorized'){const refreshToken=localStorage.getItem('refresh_token');if(refreshToken){const tokenParts=JSON.parse(atob(refreshToken.split('.')[1]));// exp date in token is expressed in seconds, while now() returns milliseconds:\nconst now=Math.ceil(Date.now()/1000);if(tokenParts.exp>now){try{const response=await axiosInstance.post('/token/refresh/',{refresh:refreshToken});localStorage.setItem('access_token',response.data.access);localStorage.setItem('refresh_token',response.data.refresh);axiosInstance.defaults.headers['Authorization']=`Bearer ${response.data.access}`;originalRequest.headers['Authorization']=`Bearer ${response.data.access}`;return axiosInstance(originalRequest);}catch(err){console.error('Failed to refresh token',err);window.location.href='/login/';}}else{console.log('Refresh token is expired',tokenParts.exp,now);window.location.href='/login/';}}else{console.log('Refresh token not available.');window.location.href='/login/';}}// specific error handling done elsewhere\nreturn Promise.reject(error);});export default axiosInstance;","map":{"version":3,"names":["axios","base_url","process","env","REACT_APP_API_BASE_URL","baseURL","axiosInstance","create","timeout","headers","Authorization","localStorage","getItem","accept","interceptors","response","use","error","originalRequest","config","alert","Promise","reject","status","url","window","location","href","data","code","statusText","refreshToken","tokenParts","JSON","parse","atob","split","now","Math","ceil","Date","exp","post","refresh","setItem","access","defaults","err","console","log"],"sources":["/app/src/axios.js"],"sourcesContent":["import axios from 'axios';\n\nconst base_url = process.env.REACT_APP_API_BASE_URL;\nconst baseURL = `${base_url}/api/`;\n\nconst axiosInstance = axios.create({\n\tbaseURL: baseURL,\n\ttimeout: 5000,\n\theaders: {\n\t\tAuthorization: localStorage.getItem('access_token')\n\t\t\t? `Bearer ${localStorage.getItem('access_token')}`\n\t\t\t: null,\n\t\t'Content-Type': 'application/json',\n\t\taccept: 'application/json',\n\t},\n});\n\naxiosInstance.interceptors.response.use(\n\t(response) => {\n\t\treturn response;\n\t},\n\tasync (error) => {\n\t\tconst originalRequest = error.config;\n\n\t\tif (!error.response) {\n\t\t\talert(\n\t\t\t\t'A server/network error occurred. ' +\n\t\t\t\t\t'Looks like CORS might be the problem. ' +\n\t\t\t\t\t'Sorry about this - we will get it fixed shortly.'\n\t\t\t);\n\t\t\treturn Promise.reject(error);\n\t\t}\n\n\t\tif (\n\t\t\terror.response.status === 401 &&\n\t\t\toriginalRequest.url === `${baseURL}token/refresh/`\n\t\t) {\n\t\t\twindow.location.href = '/login/';\n\t\t\treturn Promise.reject(error);\n\t\t}\n\n\t\tif (\n\t\t\terror.response.data.code === 'token_not_valid' &&\n\t\t\terror.response.status === 401 &&\n\t\t\terror.response.statusText === 'Unauthorized'\n\t\t) {\n\t\t\tconst refreshToken = localStorage.getItem('refresh_token');\n\n\t\t\tif (refreshToken) {\n\t\t\t\tconst tokenParts = JSON.parse(atob(refreshToken.split('.')[1]));\n\n\t\t\t\t// exp date in token is expressed in seconds, while now() returns milliseconds:\n\t\t\t\tconst now = Math.ceil(Date.now() / 1000);\n\n\t\t\t\tif (tokenParts.exp > now) {\n\t\t\t\t\ttry {\n\t\t\t\t\t\tconst response = await axiosInstance.post('/token/refresh/', { refresh: refreshToken });\n\t\t\t\t\t\tlocalStorage.setItem('access_token', response.data.access);\n\t\t\t\t\t\tlocalStorage.setItem('refresh_token', response.data.refresh);\n\n\t\t\t\t\t\taxiosInstance.defaults.headers['Authorization'] = `Bearer ${response.data.access}`;\n\t\t\t\t\t\toriginalRequest.headers['Authorization'] = `Bearer ${response.data.access}`;\n\n\t\t\t\t\t\treturn axiosInstance(originalRequest);\n\t\t\t\t\t} catch (err) {\n\t\t\t\t\t\tconsole.error('Failed to refresh token', err);\n\t\t\t\t\t\twindow.location.href = '/login/';\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\tconsole.log('Refresh token is expired', tokenParts.exp, now);\n\t\t\t\t\twindow.location.href = '/login/';\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tconsole.log('Refresh token not available.');\n\t\t\t\twindow.location.href = '/login/';\n\t\t\t}\n\t\t}\n\n\t\t// specific error handling done elsewhere\n\t\treturn Promise.reject(error);\n\t}\n);\n\nexport default axiosInstance;"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module"}